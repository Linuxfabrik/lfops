- block:

  - name: 'Make sure that Ansible facts directory exists'
    ansible.builtin.file:
      path: '/etc/ansible/facts.d'
      state: 'directory'
      owner: 'root'
      group: 'root'
      mode: 0o755

  - name: 'Limit shell__commands__combined_var if shell__limit_cmd is set'
    ansible.builtin.set_fact:
      shell__commands__combined_var: '{{ shell__commands__combined_var | selectattr("name", "in", shell__limit_cmd) | list }}'
    when:
      - 'shell__limit_cmd is defined and shell__limit_cmd | length'

  - ansible.builtin.include_tasks: 'run-commands.yml'
    loop: '{{ shell__commands__combined_var | sort(attribute="name") }}'
    loop_control:
      label: 'path={{ item["name"] }}, state={{ item["state"] | d("present") }}'

  tags:
    - 'shell'
