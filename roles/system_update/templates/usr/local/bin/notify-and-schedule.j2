#!/usr/bin/env bash
# {{ ansible_managed }}
# 2022030102

export LC_ALL=C

send_msg () {
{% if ansible_facts['distribution'] == 'Debian' %}
    echo -n "$MSGBODY" | mail -s "$SUBJECT" -a "From: $SENDER" "$RECIPIENTS"
{% else %}
    echo -n "$MSGBODY" | mail -s "$SUBJECT" -r "$SENDER" "$RECIPIENTS"
{% endif %}
{% if system_update__rocketchat_url is defined and system_update__rocketchat_url | length %}
    /usr/bin/curl --silent --output /dev/null --data-urlencode \
        "text=${SUBJECT}

        ${MSGBODY}
        {{ system_update__rocketchat_msg_suffix | default('') }}" \
        --data-urlencode "parse_mode=HTML" --data-urlencode "disable_web_page_preview=true" \
        "{{ system_update__rocketchat_url }}"
{% endif %}
}

SUBJECT_PREFIX="{{ system_update__mail_subject_prefix }}$(hostname --short)"
SUBJECT="$SUBJECT_PREFIX - Update at {{ system_update__update_time }}"
SENDER="{{ system_update__mail_subject_prefix }}$(hostname --short) <{{ system_update__mail_from }}>"
RECIPIENTS="{{ system_update__mail_recipients_updates | join(' ' ) }}"

cat > /tmp/check-update << 'EOF'
Please reply to this mail if you have any concerns.
A reboot might be necessary and will be done
automatically after updating your components.
---------------------------------------------------

EOF

{% if ansible_facts['os_family'] == 'RedHat' %}
yum clean all 1> /dev/null 2>&1
yum check-update >> /tmp/check-update 2> /tmp/system-update-check-stderr
retc=$?

if [ "$retc" -eq 100 ]; then
    # updates are available, so inform and schedule
    MSGBODY=$(cat /tmp/check-update)
    send_msg
		systemd-run --unit=update-and-reboot --property=TimeoutSec=0 --on-calendar="$(date -d '{{ system_update__update_time }}' +%F\ %T)" /usr/local/bin/update-and-reboot
elif [ "$retc" -eq 1 ]; then
    SUBJECT="$SUBJECT_PREFIX - System update check failed"
    MSGBODY=$(</tmp/system-update-check-stderr)
    send_msg
    exit 1
fi
{% endif %}


{% if ansible_facts['os_family'] == 'Debian' %}
apt clean 1> /dev/null 2>&1
apt update 1> /dev/null 2>&1
apt list --upgradable >> /tmp/check-update

if [ $(grep upgradable /tmp/check-update | wc -l) -gt 0 ]; then
    # updates are available, so inform and schedule
    MSGBODY=$(cat /tmp/check-update)
    send_msg
		systemd-run --unit=update-and-reboot --property=TimeoutSec=0 --on-calendar="$(date -d '{{ system_update__update_time }}' +%F\ %T)" /usr/local/bin/update-and-reboot
fi
{% endif %}
