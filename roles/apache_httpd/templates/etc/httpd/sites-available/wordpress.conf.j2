# {{ ansible_managed }}
# 2022102501
# WordPress Application vHost
{% if item['by_role'] | d() %}
# Generated by Ansible role: {{ item['by_role'] }}
{% endif %}

# {{ item['comment'] | d('no description available') }}
<VirtualHost {{ item['virtualhost_ip'] | d('*') }}:{{ item['virtualhost_port'] | d(443) }}>
    ServerName {{ item['conf_server_name'] }}
{% if item['conf_server_alias'] is defined and item['conf_server_alias'] | length %}
    ServerAlias {{ item['conf_server_alias'] }}
{% endif %}
    ServerAdmin {{ item['conf_server_admin'] | d(apache_httpd__conf_server_admin) }}

    ErrorLog "{{ item['conf_error_log'] | d('logs/' ~ item['conf_server_name'] ~ '-error.log')}}"
    LogLevel {{ item['conf_log_level'] | d('notice core:info') }}
{% if item['conf_custom_log'] is defined and item['conf_custom_log'] %}
    # log_config_module
    CustomLog {{ item['conf_custom_log'] }}
{% endif %}

    KeepAliveTimeout {{ item['conf_keep_alive_timeout'] | d(5) }}
    Timeout {{ item['conf_timeout'] | d(apache_httpd__conf_timeout) }}

    DocumentRoot "{{ item['conf_document_root'] | d(apache_httpd__conf_document_root ~ '/' ~ item['conf_server_name']) }}"
    <Directory {{ item['conf_document_root'] | d(apache_httpd__conf_document_root ~ '/' ~ item['conf_server_name']) }}>
        AllowOverride {{ item['conf_allow_override'] | d('None') }}
        Options {{ item['conf_options'] | d('None') }}
        {{ item['authz_document_root'] | d('Require local') }}
    </Directory>

    # dir_module
    DirectoryIndex {{ item['conf_directory_index'] | d(apache_httpd__mod_dir_directory_index) }}

{% if not apache_httpd__skip_php_fpm %}
    # PHP-FPM: redirect to site-specific php-fpm pool if mod_php is not available
    # Enable http authorization headers
    SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
    <FilesMatch \.(php|phar)$>
        {{ item['php_set_handler'] | d('SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"') }}
    </FilesMatch>
    # Specific PHP configuration options like "session.save_handler" have to be set
    # in /etc/php-fpm.d/{{ item['conf_server_name'] }}.conf, for example
{% endif %}

    # reqtimeout_module
    # set timeout values for receiving the request headers and/or body from client
    RequestReadTimeout {{ item['conf_request_read_timeout'] | d('header=20-40,MinRate=500 body=20,MinRate=500') }}

    # rewrite_module
    RewriteEngine On

    # limit allowed http request methods
    RewriteCond %{REQUEST_METHOD} !^({{ item['allowed_http_methods'] | d(['GET', 'OPTIONS']) | join('|') }})
    RewriteRule .* - [redirect=405,last]

    # disable old HTTP protocol versions
    # just allow those ones listed below
    RewriteCond %{THE_REQUEST} !HTTP/1\.1$
    RewriteCond %{THE_REQUEST} !HTTP/2
    RewriteCond %{THE_REQUEST} !HTTP/3
    RewriteRule .* - [forbidden]

    # requests without a hostname are disallowed
    RewriteCond %{HTTP_HOST} !^{{ item['conf_server_name'] | regex_escape() }} [nocase]
    RewriteCond %{REQUEST_URI} !^/error [nocase]
    RewriteRule ^.(.*) - [last,forbidden]

    # block requests with empty http_user_agent string
    RewriteCond %{HTTP_USER_AGENT} ^(?:\s|-)*$
    RewriteRule ^ - [nocase,forbidden,last]

    # block access to wordpress configuration files and xml-rpc
    <FilesMatch "wp-config\.php|xmlrpc\.php|error_log|readme\.html|license\.txt|wp-config-sample\.php">
        Require all denied
    </FilesMatch>

    # block hotlinking
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^http(?:s)?://{{ wordpress__url | regex_escape() }}(?:/.*)?$ [nocase]
    RewriteRule \.(?:jpe?g|gif|png|svg|webp|zip|rar|pdf)$ - [nocase,forbidden,last]

    # block direct access to /wp-includes
    RewriteRule ^wp-admin/includes/ - [nocase,forbidden,last]
    RewriteRule !^wp-includes/ - [skip=3]
    RewriteRule ^wp-includes/[^/]+\.php$ - [nocase,forbidden,last]
    RewriteRule ^wp-includes/js/tinymce/langs/.+\.php - [nocase,forbidden,last]
    RewriteRule ^wp-includes/theme-compat/ - [nocase,forbidden,last]

    # block wordpress author scans
    RewriteCond %{QUERY_STRING} (author=\d+) [nocase]
    RewriteRule ^ - [nocase,forbidden,last]

    # reduce automated wordpress comment spam
    RewriteCond %{REQUEST_METHOD} POST [nocase]
    RewriteCond %{REQUEST_URI} wp-comments-post\.php [nocase]
    RewriteCond %{HTTP_REFERER} !^http(s)?://{{ wordpress__url | regex_escape() }}(/.*)?$ [OR,nocase]
    RewriteCond %{HTTP_USER_AGENT} ^(?:\s|-)*$
    RewriteRule ^ - [nocase,forbidden,last]

{% if item['raw'] | d() %}
# raw content
{{ item['raw'] }}
{% endif %}
</VirtualHost>
