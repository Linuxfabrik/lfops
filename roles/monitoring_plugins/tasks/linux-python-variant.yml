- block:

  - name: 'Clone the lib git repo to localhost (version: {{ monitoring_plugins__github_version | d(monitoring_plugins__repo_version) }})'
    ansible.builtin.git:
      repo: '{{ monitoring_plugins__lib_repo_url }}'
      dest: '/tmp/ansible.lib-repo'
      version: '{{ monitoring_plugins__github_version | d(monitoring_plugins__repo_version) }}'
      depth: 1
    delegate_to: 'localhost'
    run_once: true
    check_mode: false # run task even if `--check` is specified

  rescue:

    - name: 'Remove the old repo and clone again'
      ansible.builtin.file:
        path: '/tmp/ansible.lib-repo'
        state: 'absent'
      delegate_to: 'localhost'

    - name: 'Clone the lib git repo to localhost (version: {{ monitoring_plugins__github_version | d(monitoring_plugins__repo_version) }})'
      ansible.builtin.git:
        repo: '{{ monitoring_plugins__lib_repo_url }}'
        dest: '/tmp/ansible.lib-repo'
        version: '{{ monitoring_plugins__github_version | d(monitoring_plugins__repo_version) }}'
        depth: 1
      delegate_to: 'localhost'
      run_once: true
      check_mode: false # run task even if `--check` is specified

  tags:
    - 'monitoring_plugins'


- block:

  - name: 'Ensure the lib folder exists (Linux)'
    ansible.builtin.file:
      path: '/usr/lib64/nagios/plugins/lib'
      state: 'directory'
      mode: 0o755

  - name: 'Copy lib for the Linuxfabrik monitoring plugins (Linux)'
    ansible.builtin.copy:
      src: '{{ item }}'
      dest: '/usr/lib64/nagios/plugins/lib'
      owner: 'root'
      mode: 0o755
    with_fileglob:
      - '/tmp/ansible.lib-repo/*{{ monitoring_plugins__python_version }}.py'
      - '/tmp/ansible.lib-repo/__init__.py'

  - name: 'Copy the Linuxfabrik monitoring plugins (Linux)'
    ansible.builtin.copy:
      src: '/tmp/ansible.monitoring-plugins-repo/check-plugins/{{ item }}/{{ item }}{{ monitoring_plugins__python_version }}'
      dest: '/usr/lib64/nagios/plugins/{{ item }}'
      owner: 'root'
      mode: 0o755
    loop: '{{ monitoring_plugins__plugin_list }}'

  - block:

    - block:

      - name: 'Create the list of available notification plugins'
        ansible.builtin.find:
          paths: '/tmp/ansible.monitoring-plugins-repo/notification-plugins/'
          recurse: true
          depth: 2
          hidden: true
        register: 'monitoring_plugins__notification_find_result'
        run_once: true

      - name: 'Apply filters'
        ansible.builtin.set_fact:
          monitoring_plugins__notification_plugin_list: "{{
              monitoring_plugins__notification_find_result.files
              | map(attribute='path')
              | map('regex_search', '/tmp/ansible\\.monitoring-plugins-repo/notification-plugins/(?P<check>.*)/' ~ monitoring_plugins__check_plugin_search_name)
              | map('regex_replace', '/tmp/ansible\\.monitoring-plugins-repo/notification-plugins/(?P<check>.*)/' ~ monitoring_plugins__check_plugin_search_name, '\\g<check>')
              | reject('search', 'example')
              | reject('search', 'None')
              | select('string') | list | unique
            }}"

      # block
      delegate_to: 'localhost'
      check_mode: false # run task even if `--check` is specified

    - name: 'Copy the Linuxfabrik notification plugins (Linux)'
      ansible.builtin.copy:
        src: '/tmp/ansible.monitoring-plugins-repo/notification-plugins/{{ item }}/{{ item }}{{ monitoring_plugins__python_version }}'
        dest: '/usr/lib64/nagios/plugins/{{ item }}'
        owner: 'root'
        mode: 0o755
      loop: '{{ monitoring_plugins__notification_plugin_list }}'

    # block
    when: 'not monitoring_plugins__skip_notification_plugins__combined_var | bool'

  tags:
    - 'monitoring_plugins'
