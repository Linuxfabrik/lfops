#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# Copyright: (c) 2026, Linuxfabrik GmbH, Zurich, Switzerland, https://www.linuxfabrik.ch
# The Unlicense (see LICENSE or https://unlicense.org/)

import csv
import os
import sys

import lib.db_sqlite


def main():
    script_dir = os.path.dirname(os.path.abspath(__file__))
    db_path = os.path.join(script_dir, 'stig.db')

    if not os.path.exists(db_path):
        print(f'Database does not exist: {db_path}')
        sys.exit(1)

    success, conn = lib.db_sqlite.connect(path=os.path.dirname(db_path), filename=os.path.basename(db_path))
    if not success:
        print(f'Failed to connect to database: {conn}')
        sys.exit(1)

    tables = ['profile', 'audit', 'remediation']

    for table in tables:
        csv_path = os.path.join(script_dir, f'{table}.csv')
        success, rows = lib.db_sqlite.select(conn, f'SELECT * FROM {table}')
        if not success:
            print(f'Failed to select from {table}: {rows}')
            sys.exit(1)

        if not rows:
            # Write empty file with just headers
            success, cols = lib.db_sqlite.select(conn, f'PRAGMA table_info({table})')
            if success and cols:
                fieldnames = [col['name'] for col in cols]
                with open(csv_path, 'w', newline='') as f:
                    writer = csv.DictWriter(f, fieldnames=fieldnames)
                    writer.writeheader()
                print(f'Dumped {table} (0 rows) to {csv_path}')
            continue

        fieldnames = list(rows[0].keys())
        with open(csv_path, 'w', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(rows)
        print(f'Dumped {table} ({len(rows)} rows) to {csv_path}')

    lib.db_sqlite.close(conn)


if __name__ == '__main__':
    main()
