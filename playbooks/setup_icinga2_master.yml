- name: 'Playbook linuxfabrik.lfops.setup_icinga2_master'
  hosts:
    - 'lfops_setup_icinga2_master'


  vars:

    setup_icinga2_master__apache_httpd__skip_injections__internal_var: '{{ setup_icinga2_master__apache_httpd__skip_injections | d(setup_icinga2_master__apache_httpd__skip_role__internal_var) }}'
    setup_icinga2_master__apache_httpd__skip_role__internal_var: '{{ setup_icinga2_master__apache_httpd__skip_role | d(false) }}'
    setup_icinga2_master__grafana__skip_role__internal_var: '{{ setup_icinga2_master__grafana__skip_role | d(false) }}'
    setup_icinga2_master__grafana_grizzly__skip_injections__internal_var: '{{ setup_icinga2_master__grafana_grizzly__skip_injections | d(setup_icinga2_master__grafana_grizzly__skip_role__internal_var) }}'
    setup_icinga2_master__grafana_grizzly__skip_role__internal_var: '{{ setup_icinga2_master__grafana_grizzly__skip_role | d(false) }}'
    setup_icinga2_master__icinga2_master__skip_injections__internal_var: '{{ setup_icinga2_master__icinga2_master__skip_injections | d(setup_icinga2_master__icinga2_master__skip_role__internal_var) }}'
    setup_icinga2_master__icinga2_master__skip_role__internal_var: '{{ setup_icinga2_master__icinga2_master__skip_role | d(false) }}'
    setup_icinga2_master__icinga_kubernetes__skip_injections__internal_var: '{{ setup_icinga2_master__icinga_kubernetes__skip_injections | d(setup_icinga2_master__icinga_kubernetes__skip_role__internal_var) }}'
    setup_icinga2_master__icinga_kubernetes__skip_role__internal_var: '{{ setup_icinga2_master__icinga_kubernetes__skip_role | d(true) }}'
    setup_icinga2_master__icinga_kubernetes_web__skip_injections__internal_var: '{{ setup_icinga2_master__icinga_kubernetes_web__skip_injections | d(setup_icinga2_master__icinga_kubernetes_web__skip_role__internal_var) }}'
    setup_icinga2_master__icinga_kubernetes_web__skip_role__internal_var: '{{ setup_icinga2_master__icinga_kubernetes_web__skip_role | d(true) }}'
    setup_icinga2_master__icingadb__skip_injections__internal_var: '{{ setup_icinga2_master__icingadb__skip_injections | d(setup_icinga2_master__icingadb__skip_role__internal_var) }}'
    setup_icinga2_master__icingadb__skip_role__internal_var: '{{ setup_icinga2_master__icingadb__skip_role | d(false) }}'
    setup_icinga2_master__icingadb_web__skip_injections__internal_var: '{{ setup_icinga2_master__icingadb_web__skip_injections | d(setup_icinga2_master__icingadb_web__skip_role__internal_var) }}'
    setup_icinga2_master__icingadb_web__skip_role__internal_var: '{{ setup_icinga2_master__icingadb_web__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2__skip_injections | d(setup_icinga2_master__icingaweb2__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2_module_businessprocess__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_businessprocess__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_company__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_company__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_cube__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_cube__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_director__skip_injections | d(setup_icinga2_master__icingaweb2_module_director__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_director__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_director__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2_module_doc__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_doc__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2_module_fileshipper__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_fileshipper__skip_injections | d(setup_icinga2_master__icingaweb2_module_fileshipper__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_fileshipper__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_fileshipper__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_generictts__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_generictts__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_grafana__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_grafana__skip_injections | d(setup_icinga2_master__icingaweb2_module_grafana__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_grafana__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_grafana__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2_module_incubator__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_incubator__skip_role | d(false) }}'
    setup_icinga2_master__icingaweb2_module_jira__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_jira__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_monitoring__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_monitoring__skip_injections | d(setup_icinga2_master__icingaweb2_module_monitoring__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_monitoring__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_monitoring__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_pdfexport__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_pdfexport__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_reporting__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_reporting__skip_injections | d(setup_icinga2_master__icingaweb2_module_reporting__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_reporting__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_reporting__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections | d(setup_icinga2_master__icingaweb2_module_vspheredb__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_vspheredb__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_vspheredb__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_module_x509__skip_injections__internal_var: '{{ setup_icinga2_master__icingaweb2_module_x509__skip_injections | d(setup_icinga2_master__icingaweb2_module_x509__skip_role__internal_var) }}'
    setup_icinga2_master__icingaweb2_module_x509__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_module_x509__skip_role | d(true) }}'
    setup_icinga2_master__icingaweb2_theme_linuxfabrik__skip_role__internal_var: '{{ setup_icinga2_master__icingaweb2_theme_linuxfabrik__skip_role | d(false) }}'
    setup_icinga2_master__influxdb__skip_injections__internal_var: '{{ setup_icinga2_master__influxdb__skip_injections | d(setup_icinga2_master__influxdb__skip_role__internal_var) }}'
    setup_icinga2_master__influxdb__skip_role__internal_var: '{{ setup_icinga2_master__influxdb__skip_role | d(false) }}'
    setup_icinga2_master__kernel_settings__skip_role__internal_var: '{{ setup_icinga2_master__kernel_settings__skip_role | d(false) }}'
    setup_icinga2_master__mariadb_server__skip_injections__internal_var: '{{ setup_icinga2_master__mariadb_server__skip_injections | d(setup_icinga2_master__mariadb_server__skip_role__internal_var) }}'
    setup_icinga2_master__mariadb_server__skip_role__internal_var: '{{ setup_icinga2_master__mariadb_server__skip_role | d(false) }}'
    setup_icinga2_master__monitoring_plugins__skip_role__internal_var: '{{ setup_icinga2_master__monitoring_plugins__skip_role | d(false) }}'
    setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_injections__internal_var: '{{ setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_injections | d(setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_role__internal_var) }}'
    setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_role__internal_var: '{{ setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_role | d(false) }}'
    setup_icinga2_master__php__skip_role__internal_var: '{{ setup_icinga2_master__php__skip_role | d(false) }}'
    setup_icinga2_master__policycoreutils__skip_role__internal_var: '{{ setup_icinga2_master__policycoreutils__skip_role | d(false) }}'
    setup_icinga2_master__python__skip_role__internal_var: '{{ setup_icinga2_master__python__skip_role | d(false) }}'
    setup_icinga2_master__python_venv__skip_role__internal_var: '{{ setup_icinga2_master__python_venv__skip_role | d(false) }}'
    setup_icinga2_master__redis__skip_injections__internal_var: '{{ setup_icinga2_master__redis__skip_injections | d(setup_icinga2_master__redis__skip_role__internal_var) }}'
    setup_icinga2_master__redis__skip_role__internal_var: '{{ setup_icinga2_master__redis__skip_role | d(false) }}'
    setup_icinga2_master__repo_epel__skip_role__internal_var: '{{ setup_icinga2_master__repo_epel__skip_role | d(false) }}'
    setup_icinga2_master__repo_grafana__skip_role__internal_var: '{{ setup_icinga2_master__repo_grafana__skip_role | d(false) }}'
    setup_icinga2_master__repo_icinga__skip_role__internal_var: '{{ setup_icinga2_master__repo_icinga__skip_role | d(false) }}'
    setup_icinga2_master__repo_influxdb__skip_role__internal_var: '{{ setup_icinga2_master__repo_influxdb__skip_role | d(false) }}'
    setup_icinga2_master__repo_mariadb__skip_role__internal_var: '{{ setup_icinga2_master__repo_mariadb__skip_role | d(false) }}'
    setup_icinga2_master__repo_monitoring_plugins__skip_role__internal_var: '{{ setup_icinga2_master__repo_monitoring_plugins__skip_role | d(false) }}'
    setup_icinga2_master__repo_mydumper__skip_role__internal_var: '{{ setup_icinga2_master__repo_mydumper__skip_role | d(false) }}'
    setup_icinga2_master__repo_redis__skip_role__internal_var: '{{ setup_icinga2_master__repo_redis__skip_role | d(false) }}'
    setup_icinga2_master__repo_remi__skip_role__internal_var: '{{ setup_icinga2_master__repo_remi__skip_role | d(false) }}'
    setup_icinga2_master__repo_sury__skip_role__internal_var: '{{ setup_icinga2_master__repo_sury__skip_role | d(false) }}'
    setup_icinga2_master__selinux__skip_role__internal_var: '{{ setup_icinga2_master__selinux__skip_role | d(false) }}'
    setup_icinga2_master__yum_utils__skip_role__internal_var: '{{ setup_icinga2_master__yum_utils__skip_role | d(false) }}'


  pre_tasks:
    - ansible.builtin.import_role:
        name: 'shared'
        tasks_from: 'log-start.yml'
      tags:
        - 'always'


  roles:

    - role: 'linuxfabrik.lfops.repo_baseos'
      repo_baseos__crb_repo_enabled__dependent_var: '{{
          repo_epel__repo_baseos__crb_repo_enabled__dependent_var
        }}'
      # Since the CRB repository is included in Rocky9 default repo file now, this will be done on Rocky9 Systems only. Formerly it came from epel repository.
      when:
        - 'ansible_facts["distribution"] == "Rocky" and ansible_facts["distribution_major_version"] == "9"'
        - 'not setup_icinga2_master__skip_repo_baseos | d(false)'

    - role: 'linuxfabrik.lfops.repo_epel'
      when:
        - 'ansible_facts["os_family"] == "RedHat" and ansible_facts["distribution_major_version"] in ["7", "8", "9"]'
        - 'not setup_icinga2_master__repo_epel__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_mariadb'
      when:
        - 'not setup_icinga2_master__repo_mariadb__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.python'
      python__modules__dependent_var: '{{
          (not setup_icinga2_master__apache_httpd__skip_injections__internal_var) | ternary(apache_httpd__python__modules__dependent_var, []) +
          (not setup_icinga2_master__mariadb_server__skip_injections__internal_var) | ternary(mariadb_server__python__modules__dependent_var[ansible_facts["os_family"]], [])
        }}'
      when:
        - 'not setup_icinga2_master__python__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_mydumper'
      when:
        - 'not setup_icinga2_master__repo_mydumper__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.policycoreutils'
      when:
        - 'ansible_facts["os_family"] == "RedHat"'
        - 'not setup_icinga2_master__policycoreutils__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.mariadb_server'
      mariadb_server__databases__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var) | ternary(icingaweb2_module_vspheredb__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_x509__skip_injections__internal_var) | ternary(icingaweb2_module_x509__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_reporting__skip_injections__internal_var) | ternary(icingaweb2_module_reporting__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var) | ternary(icingaweb2_module_director__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icingadb__skip_injections__internal_var) | ternary(icingadb__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icinga_kubernetes__skip_injections__internal_var) | ternary(icinga_kubernetes__mariadb_server__databases__dependent_var, []) +
          (not setup_icinga2_master__icinga2_master__skip_injections__internal_var) | ternary(icinga2_master__mariadb_server__databases__dependent_var, [])
        }}'
      mariadb_server__users__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var) | ternary(icingaweb2_module_vspheredb__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_x509__skip_injections__internal_var) | ternary(icingaweb2_module_x509__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_reporting__skip_injections__internal_var) | ternary(icingaweb2_module_reporting__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var) | ternary(icingaweb2_module_director__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icingadb__skip_injections__internal_var) | ternary(icingadb__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icinga_kubernetes__skip_injections__internal_var) | ternary(icinga_kubernetes__mariadb_server__users__dependent_var, []) +
          (not setup_icinga2_master__icinga2_master__skip_injections__internal_var) | ternary(icinga2_master__mariadb_server__users__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__mariadb_server__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_influxdb'
      when:
        - 'not setup_icinga2_master__repo_influxdb__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.python_venv'
      python_venv__venvs__dependent_var: '{{
          (not setup_icinga2_master__influxdb__skip_injections__internal_var) | ternary(influxdb__python_venv__venvs__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__python_venv__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_grafana'
      when:
        - 'not setup_icinga2_master__repo_grafana__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.grafana'
      grafana__provisioning_datasources__dependent_var: '{{ (not setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_injections__internal_var) | ternary(monitoring_plugins_grafana_dashboards__grafana__provisioning_datasources__dependent_var, "") }}'
      grafana__provisioning_service_accounts__dependent_var: '{{
          (not setup_icinga2_master__grafana_grizzly__skip_injections__internal_var) | ternary(grafana_grizzly__grafana__provisioning_service_accounts__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__grafana__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.grafana_grizzly'
      when:
        - 'not setup_icinga2_master__grafana_grizzly__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.influxdb'
      influxdb__databases__dependent_var: '{{
          (not setup_icinga2_master__icinga2_master__skip_injections__internal_var) | ternary(icinga2_master__influxdb__databases__dependent_var, [])
        }}'
      influxdb__users__dependent_var: '{{
          (not setup_icinga2_master__icinga2_master__skip_injections__internal_var) | ternary(icinga2_master__influxdb__users__dependent_var, []) +
          (not setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_injections__internal_var) | ternary(monitoring_plugins_grafana_dashboards__influxdb__users__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__influxdb__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_icinga'
      when:
        - 'not setup_icinga2_master__repo_icinga__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icinga2_master'
      icinga2_master__api_users__dependent_var: '{{
          (not setup_icinga2_master__icingadb_web__skip_injections__internal_var) | ternary(icingadb_web__icinga2_master__api_users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__icinga2_master__api_users__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var) | ternary(icingaweb2_module_director__icinga2_master__api_users__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__icinga2_master__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.yum_utils'
      when:
        - 'ansible_facts["os_family"] == "RedHat"'
        - 'ansible_facts["distribution_major_version"] in ["7"]'
        - 'not setup_icinga2_master__yum_utils__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_remi'
      when:
        - 'ansible_facts["os_family"] == "RedHat" and ansible_facts["distribution_major_version"] in ["7", "8", "9"]'
        - 'not setup_icinga2_master__repo_remi__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_sury'
      when:
        - 'ansible_facts["os_family"] == "Debian"'
        - 'not setup_icinga2_master__repo_sury__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.php'
      php__ini_upload_max_filesize__dependent_var: '{{ (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__php__ini_upload_max_filesize__dependent_var, "") }}'
      php__modules__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_fileshipper__skip_injections__internal_var) | ternary(icingaweb2_module_fileshipper__php__modules__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var) | ternary(icingaweb2_module_vspheredb__php__modules__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_x509__skip_injections__internal_var) | ternary(icingaweb2_module_x509__php__modules__dependent_var[ansible_facts["os_family"]], []) +
          (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__php__modules__dependent_var[ansible_facts["os_family"]], [])
        }}'
      when:
        - 'not setup_icinga2_master__php__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.apache_httpd'
      apache_httpd__mods__dependent_var: '{{ (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__apache_httpd__mods__dependent_var, "") }}'
      apache_httpd__vhosts__dependent_var: '{{ (not setup_icinga2_master__icingaweb2__skip_injections__internal_var) | ternary(icingaweb2__apache_httpd__vhosts__dependent_var, "") }}'
      when:
        - 'not setup_icinga2_master__apache_httpd__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2'
      icingaweb2__navigation_menu_entries__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_grafana__skip_injections__internal_var) | ternary(icingaweb2_module_grafana__icingaweb2__navigation_menu_entries__dependent_var, [])
        }}'
      icingaweb2__resources__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var) | ternary(icingaweb2_module_vspheredb__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_x509__skip_injections__internal_var) | ternary(icingaweb2_module_x509__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_monitoring__skip_injections__internal_var) | ternary(icingaweb2_module_monitoring__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_reporting__skip_injections__internal_var) | ternary(icingaweb2_module_reporting__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var) | ternary(icingaweb2_module_director__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icingadb_web__skip_injections__internal_var) | ternary(icingadb_web__icingaweb2__resources__dependent_var, []) +
          (not setup_icinga2_master__icinga_kubernetes_web__skip_injections__internal_var) | ternary(icinga_kubernetes_web__icingaweb2__resources__dependent_var, [])
        }}'
      icingaweb2__users__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_director__skip_injections__internal_var) | ternary(icingaweb2_module_director__icingaweb2__users__dependent_var, [])
        }}'
      when:
        - 'not setup_icinga2_master__icingaweb2__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_monitoring_plugins'
      when:
        - 'not setup_icinga2_master__repo_monitoring_plugins__skip_role__internal_var'

    # note: monitoring_plugins role needs to run after the icingaweb2 role to deploy the icons
    - role: 'linuxfabrik.lfops.monitoring_plugins'
      when:
        - 'not setup_icinga2_master__monitoring_plugins__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.selinux'
      selinux__booleans__dependent_var: '{{
          (not setup_icinga2_master__apache_httpd__skip_injections__internal_var) | ternary(apache_httpd__selinux__booleans__dependent_var, []) +
          (not setup_icinga2_master__icinga2_master__skip_injections__internal_var) | ternary(icinga2_master__selinux__booleans__dependent_var, [])
        }}'
      selinux__fcontexts__dependent_var: '{{
          (not setup_icinga2_master__icingaweb2_module_vspheredb__skip_injections__internal_var) | ternary(icingaweb2_module_vspheredb__selinux__fcontexts__dependent_var, [])
        }}'
      when:
        - 'ansible_facts["os_family"] == "RedHat"'
        - 'not setup_icinga2_master__selinux__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.kernel_settings'
      kernel_settings__sysctl__dependent_var: '{{
          (not setup_icinga2_master__mariadb_server__skip_injections__internal_var) | ternary(mariadb_server__kernel_settings__sysctl__dependent_var, []) | d([]) +
          (not setup_icinga2_master__redis__skip_injections__internal_var) | ternary(redis__kernel_settings__sysctl__dependent_var, []) | d([])
        }}'
      kernel_settings__transparent_hugepages__dependent_var: '{{ (not setup_icinga2_master__redis__skip_injections__internal_var) | ternary(redis__kernel_settings__transparent_hugepages__dependent_var, "") }}'
      when:
        - 'not setup_icinga2_master__kernel_settings__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.repo_redis'
      when:
        - 'ansible_facts["os_family"] == "Debian"' # not available for RedHat, instead using repo_remi there
        - 'not setup_icinga2_master__repo_redis__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.redis'
      redis__conf_save__dependent_var: '{{ icinga2_master__redis__conf_save__dependent_var if (not setup_icinga2_master__redis__skip_injections__internal_var) else none }}'
      when:
        - 'not setup_icinga2_master__redis__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingadb'
      when:
        - 'not setup_icinga2_master__icingadb__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icinga_kubernetes'
      when:
        - 'not setup_icinga2_master__icinga_kubernetes__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icinga_kubernetes_web'
      when:
        - 'not setup_icinga2_master__icinga_kubernetes_web__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingadb_web'
      when:
        - 'not setup_icinga2_master__icingadb_web__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_doc'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_doc__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_fileshipper'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_fileshipper__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_generictts'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_generictts__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_x509'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_x509__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_monitoring'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_monitoring__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_reporting'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_reporting__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_businessprocess'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_businessprocess__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_company'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_company__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_cube'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_cube__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_theme_linuxfabrik'
      when:
        - 'not setup_icinga2_master__icingaweb2_theme_linuxfabrik__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_incubator'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_incubator__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_jira'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_jira__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_pdfexport'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_pdfexport__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_vspheredb'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_vspheredb__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_director'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_director__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.icingaweb2_module_grafana'
      when:
        - 'not setup_icinga2_master__icingaweb2_module_grafana__skip_role__internal_var'

    - role: 'linuxfabrik.lfops.monitoring_plugins_grafana_dashboards'
      when:
        - 'not setup_icinga2_master__monitoring_plugins_grafana_dashboards__skip_role__internal_var'


  post_tasks:
    - ansible.builtin.import_role:
        name: 'shared'
        tasks_from: 'log-end.yml'
      tags:
        - 'always'
